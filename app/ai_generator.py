import json
import os
import anthropic
import config
from app.db import get_db
from app.pdf_extractor import get_topic_content

SYSTEM_PROMPT = """# הגדרת תפקיד ומומחיות

אתה מומחה בינלאומי מוביל בשני תחומים:

## פסיכומטריקה ובניית מבחנים
- בעל 20+ שנות ניסיון בפיתוח מבחנים סטנדרטיים להסמכה רפואית
- מומחה בעקרונות פסיכומטריים: תוקף (validity), מהימנות (reliability), הבחנה (discrimination)
- מתמחה ב-MCQ בסטנדרט NBME/USMLE לבחינות רפואיות
- יודע למנוע פגמים נפוצים: cues, vagueness, ambiguity, testwiseness
- מכיר את taxonomy של Bloom ויוצר שאלות ברמות חשיבה גבוהות

## פסיכיאטריה של הילד והמתבגר
- פסיכיאטר ילדים מוסמך עם ניסיון קליני נרחב
- בקיא מעולה ב-DSM-5-TR וב-ICD-11
- מכיר לעומק את ספרי הלימוד המובילים:
  * Dulcan's Textbook of Child and Adolescent Psychiatry (2nd Edition)
  * Kaplan & Sadock's Synopsis of Psychiatry
  * AACAP Practice Parameters
- עדכני במחקר, הנחיות טיפול, ופרמקולוגיה בפסיכיאטריית ילדים
- מבין את המציאות הקלינית הישראלית והאתגרים המקומיים

---

# עקרונות יסוד לבניית שאלות MCQ איכותיות

## מבנה השאלה האידיאלי

### 1. Clinical Vignette (תיאור מקרה)
**חייב להיות:**
- **מציאותי ורלוונטי קלינית**: מבוסס על מקרים שרופא באמת פוגש
- **תמציתי ומדויק**: רק מידע קליני רלוונטי, ללא "רעש"
- **מתאים לגיל**: התפתחותי מדויק (שפה, התנהגות, קוגניציה)
- **מובנה היטב**:
  * פתיחה: גיל, מגדר, הקשר הפניה
  * אמצע: תסמינים עיקריים, משך, חומרה
  * סיום: ממצאים רלוונטיים (בדיקה, היסטוריה, הקשר משפחתי)

**להימנע מ:**
- מידע מיותר שמסיח את הדעת
- שפה מסורבלת או אקדמית מדי
- אי-בהירויות או סתירות פנימיות
- stereotypes או bias תרבותי/מגדרי

### 2. Lead-in Question (השאלה)
**חייבת להיות:**
- **ממוקדת ובודקת נקודה אחת**: לא שאלה כפולה
- **ברורה לחלוטין**: ניסוח חד-משמעי
- **ברמת חשיבה גבוהה**:
  * **Application**: "מהו הטיפול הראשוני המועדף?"
  * **Analysis**: "מהו האבחנה הסבירה ביותר?"
  * **Evaluation**: "איזו בדיקה הכי חשובה לבצע?"
  * **Synthesis**: "מהו הגורם הסביר ביותר לתסמינים?"

**להימנע מ:**
- שאלות טריוויאליות (זכירה בלבד)
- שאלות שליליות ("מה לא נכון?") - אלא אם הכרחי
- ניסוחים מבלבלים: "EXCEPT", "NOT", "LEAST"

### 3. Answer Options (תשובות אפשריות)
**חייבות להיות:**
- **הומוגניות**: אותה קטגוריה (כולן אבחנות, כולן טיפולים)
- **באורך דומה**: התשובה הנכונה לא תמיד הארוכה ביותר
- **סבירות קלינית**: כל distractor הגיוני במקרה דומה
- **מבחינות**: distractors קרובים מספיק כדי לבחון הבנה עמוקה
- **ללא cues לשוניים**: לא לחזור על מילים מה-vignette רק בתשובה הנכונה

**Distractors איכותיים צריכים:**
- להיות טעויות נפוצות של תלמידים
- לבחון הבחנות דיפרנציאליות קריטיות
- להימנע מלהיות אבסורדיים או בלתי אפשריים

---

# פגמים נפוצים להימנע מהם

## 1. Cueing (רמזים לא מכוונים)
- אל תעשה את התשובה הנכונה ארוכה ומפורטת יותר מהמסיחים
- כל התשובות צריכות להיות באורך ורמת פירוט דומים

## 2. Grammatical Cues
- ודא שכל האופציות עובדות דקדוקית עם ה-lead-in

## 3. Absolute Words
- הימנע מ-"תמיד", "אף פעם", "רק" (בד"כ מסמן תשובה שגויה)
- השתמש ב-"סביר ביותר", "בדרך כלל", "מועדף"

## 4. Convergence
- אל תחזור על מילים זהות מה-vignette רק בתשובה הנכונה
- השתמש בסינונימים ומינוחים שונים

## 5. Implausible Distractors
- כל distractor חייב להיות הגיוני קלינית במקרה דומה
- לא לשים טיפולים אבסורדיים (למשל ECT לילד עם ADHD קל)

---

# תוכן קליני - דגשים חשובים

## 1. דיוק אבחנתי
- שימוש ב-DSM-5-TR criteria המדויקים
- הבחנות דיפרנציאליות עדינות (ADHD vs. Anxiety, ASD vs. RAD)
- שילוב ממצאים פיזיקליים ומעבדתיים כשרלוונטיים

## 2. טיפול מבוסס ראיות
- First-line treatments לפי AACAP guidelines
- שילוב פסיכותרפיה ופרמקולוגיה
- שיקולי גיל, חומרה, קו-מורבידיות

## 3. פרמקולוגיה מדויקת
- מינונים נכונים לפי גיל ומשקל
- תופעות לוואי קריטיות
- אינטראקציות תרופתיות
- התוויות נגד

## 4. הקשר התפתחותי
- ציוני דרך נורמטיביים
- השפעת גיל על פרזנטציה
- שיקולים משפחתיים ומערכתיים

---

# תהליך עבודה

## שלב 1: ניתוח חומר הלימוד
- קרא בקפידה את החומר המצורף
- זהה learning objectives מרכזיים
- מפה נושאים לפי חשיבות קלינית ותדירות

## שלב 2: תכנון
- פיזור מאוזן של נושאים
- מגוון רמות קושי
- כיסוי מלא של תחומי התוכן

## שלב 3: כתיבת השאלה
1. התחל מ-learning objective ספציפי
2. בנה vignette מציאותי
3. נסח lead-in ברור
4. צור תשובה נכונה single best answer
5. פתח 3 distractors איכותיים
6. כתוב הסבר מנומק מקיף

## שלב 4: Quality Control
- בדוק פגמים פסיכומטריים (cues, אורך לא אחיד, מילים מוחלטות)
- ודא accuracy קליני
- אמת מול מקורות
- ודא שכל 4 האופציות הומוגניות ובאורך דומה

---

# הנחיות ספציפיות למקרה הישראלי

- שימוש בעברית תקנית ומקצועית
- מונחים רפואיים בעברית + אנגלית בסוגריים בשימוש ראשון
- התייחסות למערכת הבריאות הישראלית כשרלוונטי
- רגישות תרבותית למגוון האוכלוסייה בישראל
- מודעות לזמינות טיפולים/תרופות בארץ

---

# פורמט פלט - JSON בלבד, ללא טקסט נוסף:
{
  "questions": [
    {
      "stem": "טקסט השאלה בעברית - כולל תיאור מקרה קליני (vignette) ושאלה ממוקדת (lead-in)",
      "options": {
        "A": "תשובה א",
        "B": "תשובה ב",
        "C": "תשובה ג",
        "D": "תשובה ד"
      },
      "correct": "A",
      "explanation": "התשובה הנכונה היא A: [הסבר מפורט של 2-3 משפטים המסביר את הרציונל הקליני, כולל ציטוט או פרפרזה מהחומר המצורף]\\n\\nמקור: [שם הספר המדויק, למשל 'Synopsis of Psychiatry' או 'Dulcan's Textbook'], עמוד [מספר העמוד המדויק מהחומר המצורף]\\n\\nמדוע B שגויה: [הסבר מפורט של 1-2 משפטים - מה הטעות הקלינית, באילו מקרים זה כן היה נכון, ומה ההבדל מהמקרה הנוכחי]\\n\\nמדוע C שגויה: [הסבר מפורט של 1-2 משפטים - מה הטעות הקלינית, באילו מקרים זה כן היה נכון, ומה ההבדל מהמקרה הנוכחי]\\n\\nמדוע D שגויה: [הסבר מפורט של 1-2 משפטים - מה הטעות הקלינית, באילו מקרים זה כן היה נכון, ומה ההבדל מהמקרה הנוכחי]",
      "difficulty": "medium",
      "clinical_task": "apply"
    }
  ]
}

## הנחיות קריטיות לציטוט מקורות:
1. **חובה לבסס כל שאלה על החומר המצורף** - אל תמציא מידע שלא מופיע בטקסט
2. **ציין את מספר העמוד המדויק** - השתמש במספרי העמודים המופיעים בחומר (למשל "--- Page 145 ---")
3. **ציין את שם הספר** - "Synopsis of Psychiatry" או "Dulcan's Textbook" בהתאם למקור
4. **אם אין חומר מצורף** - ציין זאת בהסבר והסתמך על ידע כללי"""

CLINICAL_TASK_MAP = {
    'mixed': 'מגוון - שלב סוגי שאלות שונים',
    'apply': 'יישום ידע למקרה קליני - הנבחן צריך ליישם ידע תיאורטי (אבחנה, טיפול, מנגנון) על תיאור מקרה מציאותי ולהגיע להחלטה קלינית מבוססת',
    'discriminate': 'הבחנה בין אפשרויות קרובות - הנבחן צריך להבדיל בין אפשרויות דומות מאוד (אבחנות, טיפולים, מנגנונים) על בסיס הבדלים עדינים ומפתחות קליניים ספציפיים',
    'decide_uncertain': 'קבלת החלטות בתנאי אי-ודאות - הנבחן מקבל מידע חלקי, סותר, או לא חד-משמעי וצריך לבחור את הצעד הנכון ביותר למרות חוסר הוודאות',
    'prioritize': 'זיהוי דחיפות ותיעדוף - הנבחן צריך לזהות את הפעולה הדחופה או החשובה ביותר כשמוצגים מספר צרכים במקביל, כולל זיהוי red flags',
    'integrate': 'אינטגרציה בין-תחומית - הנבחן צריך לשלב ידע ממספר תחומים (פרמקולוגיה, פסיכותרפיה, התפתחות, משפחה) כדי להגיע לפתרון מקיף',
    'evaluate': 'הערכה ביקורתית - הנבחן צריך להעריך מידע קליני, לזהות מה רלוונטי ומה מסיח, ולשפוט את איכות או התאמת גישה טיפולית',
    'adapt': 'שיפוט קליני מורכב - הנבחן מתמודד עם מקרה שבו הגישה הסטנדרטית לא עובדת (אי-תגובה, סיבוכים, קומורבידיות) וצריך להתאים את התוכנית',
}

USER_PROMPT_TEMPLATE = """צור {count} שאלות רב-ברירתיות בנושא: {topic_he} ({topic_en})

רמת קושי מבוקשת:
{difficulty}

מטרת השאלה: {clinical_task}

חשוב מאוד: הקפד על רמת הקושי המבוקשת. התאם את מורכבות המקרה הקליני, את הקרבה בין המסיחים, ואת עומק הידע הנדרש בהתאם לרמה שנבחרה.

הנושא שייך לפרק: {chapter_he}

תת-נושאים שנבחרו - צור שאלות אך ורק על תת-הנושאים הבאים, אל תצור שאלות על נושאים אחרים:
{subtopics_list}

חומר מקצועי רלוונטי מתוך ספרי הלימוד (זהו המקור היחיד שלך - בסס את השאלות רק על חומר זה):
---
{content}
---

## הנחיות קריטיות - חובה לקיים:

### 1. בסיס על החומר המצורף בלבד:
- **כל שאלה חייבת להתבסס על מידע שמופיע בחומר המצורף למעלה**
- אל תמציא עובדות, מספרים, או הנחיות שלא מופיעים בטקסט
- אם החומר לא מספיק ליצירת שאלה איכותית - צור פחות שאלות אך איכותיות יותר

### 2. ציטוט מקורות מדויק:
- **ציין בכל הסבר את שם הספר ומספר העמוד המדויק** (ראה "--- Page X ---" בחומר)
- פורמט: "מקור: Synopsis of Psychiatry, עמוד 145" או "מקור: Dulcan's Textbook, עמוד 892"
- השתמש בציטוטים או פרפרזות מהחומר כדי לבסס את התשובה הנכונה

### 3. הסברים מפורטים לתשובות שגויות:
- לכל תשובה שגויה, הסבר:
  * מה הטעות הקלינית שהנבחן עלול לעשות
  * באילו מקרים אחרים התשובה הזו כן הייתה נכונה
  * מה ההבדל הספציפי מהמקרה המתואר בשאלה

### 4. הנחיות נוספות:
- צור שאלות רק על תת-הנושאים שנבחרו למעלה
- כל שאלה חייבת לעסוק בתחום מוקד אחר
- שלב תסריטים קליניים מציאותיים עם גילאים ומינים מגוונים
- העדף מצבים קליניים שכיחים ורלוונטיים לפרקטיקה היומיומית

דוגמאות לשאלות איכותיות ומגוונות:

דוגמה 1 (בירור):
פעוטה בת שנתיים וחצי הופנתה להערכה התפתחותית לאחר שהוריה דיווחו כי היא הפסיקה להשתמש במילים שכבר רכשה ומראה רגרסיה התפתחותית. בעבר השתמשה ב-10 מילים והייתה מגיבה לשם שלה, אך בחודשים האחרונים חלה נסיגה והתרחקות. היא מבלה זמן רב בתנועות חזרתיות של הידיים ומאבדת קשר עין. מהי הבדיקה החשובה ביותר לביצוע כחלק מתהליך האבחון?
A. בדיקת שמיעה  B. בדיקה גנטית  C. MRI מוח  D. EEG

דוגמה 2 (טיפול תרופתי):
נער בן 14 אובחן עם הפרעת דיכאון מג'ורי לפני 3 חודשים והחל טיפול ב-fluoxetine 20mg. ההורים מדווחים על שיפור חלקי במצב הרוח אך הנער מתלונן על חוסר שינה, אי-שקט מוטורי, ועצבנות מוגברת מאז תחילת הטיפול. מהו הצעד הטיפולי המתאים ביותר?
A. הוספת melatonin לשינה  B. הפחתת מינון ל-10mg  C. החלפה ל-sertraline  D. הוספת quetiapine במינון נמוך

דוגמה 3 (ניהול מקרה):
ילדה בת 8 עם ADHD מטופלת ב-methylphenidate. המורה מדווחת על שיפור בריכוז בשעות הבוקר אך הרעה בהתנהגות אחר הצהריים, כולל בכי, עצבנות ונסיגה חברתית. ההורים מדווחים על חוסר תיאבון וקושי להירדם. מהי ההמלצה המתאימה ביותר?
A. הוספת מנת צהריים של methylphenidate  B. מעבר לתכשיר בשחרור מושהה  C. הפחתת המינון  D. הוספת clonidine לשעות אחה"צ

דוגמה 4 (מצב חירום):
נערה בת 16 הובאה למיון לאחר שחברתה דיווחה שכתבה בהודעות טקסט על רצון למות. בהערכה, הנערה מדווחת על מחשבות אובדניות עם תוכנית מסוימת, ללא ניסיונות עבר. יש לה גישה לתרופות בבית. היא מסרבת לאשפוז. מהו הצעד הראשון המתאים ביותר?
A. שחרור עם מעקב פסיכיאטרי תוך 48 שעות  B. הערכת כשירות לסרב לאשפוז ושקילת אשפוז כפוי  C. שיחה טלפונית עם ההורים וקביעת תור דחוף  D. התחלת טיפול תרופתי SSRI ושחרור

ענה בפורמט JSON בלבד."""

DIFFICULTY_MAP = {
    'easy': """קל - שאלות ברמת בסיס:
  • מקרה קליני עם מצג טיפוסי וקלאסי של הפרעה שכיחה
  • המסיחים שייכים לקטגוריות אבחנתיות שונות בבירור (למשל: ADHD מול ASD מול חרדה מול דיכאון)
  • שאלה על הצעד הראשון והברור ביותר בבירור או בטיפול
  • דורש זיהוי ישיר של תמונה קלינית מוכרת""",

    'medium': """בינוני - שאלות ברמה מתקדמת:
  • מקרה קליני עם מצג לא-טיפוסי, חלקי, או עם קומורבידיות
  • המסיחים קרובים קלינית ושייכים לאותו אשכול אבחנתי (למשל: הבחנה בין סוגי חרדה שונים, או בין תת-סוגים של ADHD)
  • דורש שקלול של מספר נתונים קליניים יחד - גיל, מין, היסטוריה משפחתית, ממצאי הערכה
  • שאלות על אבחנה מבדלת, בחירת טיפול קו ראשון, או זיהוי גורמי סיכון
  • המסיחים מייצגים טעויות קליניות נפוצות שמתמחים עלולים לעשות""",

    'hard': """קשה - שאלות ברמת מומחה:
  • מקרה קליני מורכב עם קומורבידיות מרובה, מצגים חופפים, או מידע סותר לכאורה
  • דורש אינטגרציה של ידע מתחומים שונים: פסיכופרמקולוגיה, פסיכותרפיה, נוירוביולוגיה, התפתחות
  • המסיחים כולם נראים סבירים מאוד ודורשים הבחנה עדינה - ההבדל בין התשובה הנכונה למסיחים הוא דק ומבוסס על ניואנסים קליניים
  • שאלות על: ניהול מקרים מורכבים, החלפת/שילוב תרופות, התייחסות לתופעות לוואי, מצבים נדירים אך מסוכנים, דילמות אתיות קליניות
  • דורש ידע מעמיק של הנחיות קליניות עדכניות, מנגנוני פעולה של תרופות, או ממצאי מחקר ספציפיים
  • המקרה עשוי לכלול שלבים: מידע התחלתי → התערבות → תגובה/אי-תגובה → מה הצעד הבא""",
}


def generate_questions(topic_id, count=3, difficulty='medium', clinical_task='mixed', subtopic_ids=None):
    db = get_db()
    topic = db.execute("SELECT * FROM topics WHERE id = ?", (topic_id,)).fetchone()
    if not topic:
        raise ValueError(f"Topic {topic_id} not found")

    # Get subtopics - filter by selected IDs if provided
    if subtopic_ids:
        placeholders = ','.join('?' for _ in subtopic_ids)
        subtopics = db.execute(
            f"SELECT hebrew, english FROM topics WHERE parent_id = ? AND id IN ({placeholders})",
            [topic_id] + subtopic_ids
        ).fetchall()
    else:
        subtopics = db.execute(
            "SELECT hebrew, english FROM topics WHERE parent_id = ?", (topic_id,)
        ).fetchall()
    subtopics_text = '\n'.join(
        f'- {s["hebrew"]} ({s["english"]})' for s in subtopics
    ) or '(אין תת-נושאים מפורטים)'

    # Get mapping - try direct, then parent
    mapping = db.execute(
        "SELECT * FROM topic_mappings WHERE topic_id = ?", (topic_id,)
    ).fetchone()
    if not mapping and topic['parent_id']:
        mapping = db.execute(
            "SELECT * FROM topic_mappings WHERE topic_id = ?", (topic['parent_id'],)
        ).fetchone()

    # Extract textbook content
    content = get_topic_content(dict(mapping) if mapping else None)
    if not content:
        content = '** לא נמצאו קבצי PDF (Synopsis/Dulcan) או שאין מיפוי עמודים לנושא זה. צור שאלות על בסיס הידע הכללי שלך בנושא, וציין בהסבר: "מקור: ידע כללי (לא נמצא חומר מצורף)" **'

    user_prompt = USER_PROMPT_TEMPLATE.format(
        count=count,
        topic_he=topic['hebrew'],
        topic_en=topic['english'],
        difficulty=DIFFICULTY_MAP.get(difficulty, difficulty),
        clinical_task=CLINICAL_TASK_MAP.get(clinical_task, CLINICAL_TASK_MAP['mixed']),
        chapter_he=topic['chapter_he'],
        subtopics_list=subtopics_text,
        content=content,
    )

    api_key = os.environ.get('ANTHROPIC_API_KEY', '') or config.CLAUDE_API_KEY
    if not api_key:
        raise ValueError("ANTHROPIC_API_KEY not set. Set the environment variable or enter it when starting the app.")
    client = anthropic.Anthropic(api_key=api_key)
    response = client.messages.create(
        model=config.CLAUDE_MODEL,
        max_tokens=8192,
        system=SYSTEM_PROMPT,
        messages=[{"role": "user", "content": user_prompt}],
    )

    raw = response.content[0].text
    # Strip markdown fences
    text = raw
    if '```json' in text:
        text = text.split('```json', 1)[1].split('```', 1)[0]
    elif '```' in text:
        text = text.split('```', 1)[1].split('```', 1)[0]

    data = json.loads(text)
    questions = data.get('questions', [])

    # Log
    tokens = response.usage.input_tokens + response.usage.output_tokens
    db.execute(
        "INSERT INTO generation_log (topic_id, prompt_used, raw_response, questions_created, model_used, tokens_used) "
        "VALUES (?, ?, ?, ?, ?, ?)",
        (topic_id, user_prompt[:2000], raw[:5000], len(questions), config.CLAUDE_MODEL, tokens)
    )
    db.commit()

    # Store as drafts
    created = []
    for q in questions:
        opts = q.get('options', {})
        cursor = db.execute(
            "INSERT INTO questions (topic_id, stem_he, option_a, option_b, option_c, option_d, option_e, "
            "correct_answer, explanation_he, difficulty, bloom_level, question_type, status, ai_generated) "
            "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'draft', 1)",
            (topic_id, q.get('stem', ''),
             opts.get('A', ''), opts.get('B', ''), opts.get('C', ''), opts.get('D', ''),
             opts.get('E', ''), q.get('correct', 'A'),
             q.get('explanation', ''),
             q.get('difficulty', difficulty),
             q.get('clinical_task', clinical_task),
             q.get('clinical_task', clinical_task))
        )
        created.append(cursor.lastrowid)
    db.commit()

    return created
